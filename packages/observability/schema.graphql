type ObsAlert {
  fingerprint: String!
  alertname: String!
  severity: String
  state: String!
  summary: String
  description: String
  labels: String      # JSON-encoded key-value label map
  startsAt: String!
  duration: String!
  generatorURL: String
  silencedBy: [String!]!
  linkedContext: String  # Rich markdown injected into AI when this entity is referenced in a workstream
}

type ObsTarget {
  job: String!
  instance: String!
  health: String!     # up | down | unknown
  lastScrape: String
  lastError: String
}

type ObsLogLine {
  timestamp: String!
  service: String!
  level: String!
  message: String!
  labels: String      # JSON-encoded stream labels
}

type ObsStats {
  alertCount: Int!
  criticalCount: Int!
  warningCount: Int!
  healthyTargets: Int!
  totalTargets: Int!
  allHealthy: Boolean!
  storageBytes: Float
  ingestionRate: Float
  activeSeries: Float
}

type ObsConfig {
  prometheusUrl: String!
  lokiUrl: String!
  alertmanagerUrl: String!
  grafanaUrl: String!
  # Auth status (no secrets exposed — only whether credentials are configured)
  grafanaAuthType: String    # "api_key" | "basic" | null
  prometheusAuth: Boolean!
  lokiAuth: Boolean!
  alertmanagerAuth: Boolean!
}

# Input for saving all observability settings in one mutation.
# Omitting a field leaves it unchanged.
# Passing null or "" clears it (URLs revert to defaults, credentials are removed).
input ObsSettingsInput {
  # Service URLs
  prometheusUrl: String
  lokiUrl: String
  alertmanagerUrl: String
  grafanaUrl: String
  # Grafana credentials
  grafanaUser: String
  grafanaPassword: String
  grafanaApiKey: String
  # Prometheus basic auth
  prometheusUser: String
  prometheusPassword: String
  # Loki basic auth
  lokiUser: String
  lokiPassword: String
  # Alertmanager basic auth
  alertmanagerUser: String
  alertmanagerPassword: String
}

extend type Query {
  # Single alert by fingerprint
  obsAlert(fingerprint: String!): ObsAlert

  # All active alerts from Alertmanager
  obsAlerts: [ObsAlert!]!

  # Summary for sidebar widget (alert counts + stack health)
  obsSummary: ObsStats!

  # Prometheus scrape targets
  obsTargets: [ObsTarget!]!

  # Log entries from Loki
  obsLogs(
    logql: String
    limit: Int
    since: String
  ): [ObsLogLine!]!

  # Available Loki label values (for service/level filters)
  obsLokiLabelValues(label: String!): [String!]!

  # Current resolved config — URLs and credential status (no secrets)
  obsConfig: ObsConfig!
}

extend type Mutation {
  # Create an Alertmanager silence
  obsSilenceAlert(
    alertname: String!
    labels: String      # JSON-encoded label matchers for precise matching
    durationMinutes: Int!
    comment: String
  ): EntityActionResult!

  # Save service URLs and/or credentials to integration storage.
  # Omit fields to leave them unchanged. Pass "" to clear.
  saveObsSettings(input: ObsSettingsInput!): EntityActionResult!
}
