type ActiveAlert {
  fingerprint: String!
  alertname: String!
  severity: String
  state: String!
  summary: String
  description: String
  labels: String      # JSON-encoded key-value label map
  startsAt: String!
  duration: String!
  generatorURL: String
  silencedBy: [String!]!
  linkedContext: String  # Rich markdown injected into AI when this entity is referenced in a workstream
}

type ObsTarget {
  job: String!
  instance: String!
  health: String!     # up | down | unknown
  lastScrape: String
  lastError: String
}

type ObsLogLine {
  timestamp: String!
  service: String!
  level: String!
  message: String!
  labels: String      # JSON-encoded stream labels
}

type ObsStats {
  alertCount: Int!
  criticalCount: Int!
  warningCount: Int!
  healthyTargets: Int!
  totalTargets: Int!
  allHealthy: Boolean!
  storageBytes: Float
  ingestionRate: Float
  activeSeries: Float
}

type ObsConfig {
  prometheusUrl: String!
  lokiUrl: String!
  alertmanagerUrl: String!
  grafanaUrl: String!
  # Auth status (no secrets exposed — only whether credentials are configured)
  grafanaAuthType: String    # "api_key" | "basic" | null
  prometheusAuth: Boolean!
  lokiAuth: Boolean!
  alertmanagerAuth: Boolean!
}

# Input for saving all observability settings in one mutation.
# Omitting a field leaves it unchanged.
# Passing null or "" clears it (URLs revert to defaults, credentials are removed).
input ObsSettingsInput {
  # Service URLs
  prometheusUrl: String
  lokiUrl: String
  alertmanagerUrl: String
  grafanaUrl: String
  # Grafana credentials
  grafanaUser: String
  grafanaPassword: String
  grafanaApiKey: String
  # Prometheus basic auth
  prometheusUser: String
  prometheusPassword: String
  # Loki basic auth
  lokiUser: String
  lokiPassword: String
  # Alertmanager basic auth
  alertmanagerUser: String
  alertmanagerPassword: String
}

type ObsTimeSeries {
  metric: String!        # JSON-encoded label map, e.g. {"__name__":"up","job":"drift-web"}
  values: [[String!]!]!  # [[unix_timestamp_seconds, value_string], ...]
}

extend type Query {
  # Single alert by fingerprint
  obsAlert(fingerprint: String!): ActiveAlert

  # All active alerts from Alertmanager
  obsAlerts: [ActiveAlert!]!

  # Summary for sidebar widget (alert counts + stack health)
  obsSummary: ObsStats!

  # Prometheus scrape targets
  obsTargets: [ObsTarget!]!

  # Log entries from Loki
  obsLogs(
    logql: String
    limit: Int
    since: String
  ): [ObsLogLine!]!

  # Available Loki label values (for service/level filters)
  obsLokiLabelValues(label: String!): [String!]!

  # Current resolved config — URLs and credential status (no secrets)
  obsConfig: ObsConfig!

  # Prometheus range query — returns one time-series per matching metric
  obsQueryRange(
    query: String!
    start: String  # ISO-8601 (default: 1h ago)
    end: String    # ISO-8601 (default: now)
    step: String   # Duration string, e.g. "15s", "1m" (default: auto ~200 steps)
  ): [ObsTimeSeries!]!

  # All metric names for a Prometheus job (for the metrics picker)
  obsMetricNames(job: String): [String!]!

  # Active scrape targets for a specific Prometheus job
  obsJobTargets(job: String!): [ObsTarget!]!

  # Prometheus label names for a metric/job (for query builder filter key suggestions)
  obsPromLabelNames(metricName: String, job: String): [String!]!

  # Prometheus label values for a label key (for query builder filter value suggestions)
  obsPromLabelValues(label: String!, metricName: String, job: String): [String!]!
}

extend type Mutation {
  # Create an Alertmanager silence
  obsSilenceAlert(
    alertname: String!
    labels: String      # JSON-encoded label matchers for precise matching
    durationMinutes: Int!
    comment: String
  ): EntityActionResult!

  # Save service URLs and/or credentials to integration storage.
  # Omit fields to leave them unchanged. Pass "" to clear.
  saveObsSettings(input: ObsSettingsInput!): EntityActionResult!
}
